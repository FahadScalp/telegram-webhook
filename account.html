<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Account View</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 p-4">
  <div class="max-w-xl mx-auto bg-white p-6 rounded shadow">
    <h1 class="text-xl font-bold text-blue-800 mb-4" id="accountTitle">Account</h1>

    <div id="accountInfo" class="text-sm space-y-2 mb-4"></div>

    <div id="loginSection" class="mb-4">
      <h2 class="text-md font-semibold mb-2">🔐 تسجيل الدخول للتحكم بالتنبيهات</h2>
      <input type="text" id="username" placeholder="اسم المستخدم" class="w-full p-2 border rounded mb-2" />
      <input type="password" id="password" placeholder="كلمة السر" class="w-full p-2 border rounded mb-2" />
      <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-2 rounded">تسجيل الدخول</button>
      <p id="loginError" class="text-red-500 text-sm hidden mt-2">بيانات الدخول غير صحيحة</p>
    </div>

    <div id="alertForm" class="hidden border p-3 bg-blue-50 rounded">
      <h2 class="text-md font-semibold mb-2">🔔 إعداد تنبيه تلغرام</h2>
      <input type="text" placeholder="Bot Token" class="p-1 border rounded w-full mb-2" id="token" />
      <input type="text" placeholder="Chat ID" class="p-1 border rounded w-full mb-2" id="chat" />
      <input type="text" placeholder="Message" class="p-1 border rounded w-full mb-2" id="msg" />
      <button class="bg-green-600 text-white px-4 py-2 rounded" onclick="saveAlert()">حفظ التنبيه</button>
    </div>
  </div>

  <script>
    const accountId = window.location.pathname.split("/").pop();
    let accountData = null;

    async function loadAccount() {
      const res = await fetch("/accounts");
      const all = await res.json();
      accountData = all[accountId];
      if (!accountData) {
        document.getElementById("accountTitle").innerText = "⚠️ الحساب غير موجود";
        return;
      }

      const last = accountData.history[accountData.history.length - 1];
      const profit = (last.balance - 100).toFixed(2);
      const html = \`
        <div><strong>الاسم:</strong> \${accountData.alias}</div>
        <div><strong>الرقم:</strong> \${accountId}</div>
        <div><strong>الرصيد:</strong> \$\${last.balance.toFixed(2)}</div>
        <div><strong>الربح:</strong> \$\${profit}</div>
        <div><strong>آخر تحديث:</strong> \${new Date(last.timestamp).toLocaleString()}</div>
      \`;
      document.getElementById("accountInfo").innerHTML = html;
    }

    function handleLogin() {
      const user = document.getElementById("username").value.trim();
      const pass = document.getElementById("password").value.trim();
      const allowed = accountData?.login;
      if (allowed && allowed.user === user && allowed.pass === pass) {
        document.getElementById("alertForm").classList.remove("hidden");
        document.getElementById("loginSection").classList.add("hidden");
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    }

    function saveAlert() {
      const t = document.getElementById("token").value;
      const c = document.getElementById("chat").value;
      const m = document.getElementById("msg").value;
      console.log("Save alert for", accountId, t, c, m);
      alert("🚀 تم حفظ التنبيه (تجريبي فقط حالياً)");
    }

    loadAccount();
  </script>
</body>
</html>
